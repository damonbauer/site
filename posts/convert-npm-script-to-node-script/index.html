<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="description" content="Use node to enhance an npm script" />
    <title>Use node to enhance an npm script</title>
    <style type="text/css">body{max-width:600px;font-size:20px}</style>
  </head>
  <body>
    <header>
      <a href="/">damon bauer's blog</a><br>
      <span>developer, amateur woodworker</span>
    </header><br><br>

    <small>2021-05-24</small>
    <h1 style="margin-top:0">
      Use node to enhance an npm script
    </h1>
    <p>Here's a way that I like to enhance a minimal npm script by using node.</p>
<p>Given this folder structure:</p>
<pre><code>..
└── projects
    ├── Aces
    │   └── translations
    │       └── en-US.json
    ├── Clubs
    │   └── translations
    │       └── en-US.json
    ├── Hearts
    │   └── translations
    │       └── en-US.json
    └── Spades
        └── translations
            └── en-US.json
</code></pre>
<p>I've got an npm script that uses the <code>formatjs</code> cli to extract translations for each of the folders in the <code>projects</code> folder. Here it is, from <code>package.json</code>:</p>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;i18n:extract&quot;: &quot;formatjs extract&quot;
  }
}
</code></pre>
<p>Now, to run this, numerous flags &amp; options have to be provided. Here's how the <code>extract</code> script is executed:</p>
<pre><code class="language-shell">npm run i18n:extract -- 'projects/Hearts/**/*.ts*' --out-file projects/Hearts/translations/en-US.json --id-interpolation-pattern '[sha512:contenthash:base64:6]'
</code></pre>
<p>I'd like to remove the hassle of:</p>
<ul>
<li>remembering the options/flags order</li>
<li>having to pass specific folder names</li>
<li>remembering the <code>id-interpolation-pattern</code> flag and value</li>
</ul>
<hr>
<p>Now, let's take a look at how we can improve this by prompting to ask which project we want to run the script for.</p>
<p>First, we'll update the script in <code>package.json</code> to use <code>node</code> to execute a custom file:</p>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;i18n:extract&quot;: &quot;node i18n-extract.js&quot;
  }
}
</code></pre>
<p>and install 2 <code>devDependencies</code>:</p>
<pre><code class="language-shell">npm i -D execa prompts
</code></pre>
<h3>Getting a list of project names</h3>
<p>Now, we need a way to get a list of the projects in the <code>projects/</code> directory. In a new file at the root of the project (let's call it <code>utilities.js</code>):</p>
<pre><code class="language-js">const fs = require('fs');
const path = require('path');
const projectsPath = __dirname + '/projects';

module.exports = {
  projectNames: fs
    .readdirSync(projectsPath)
    .filter((fileOrDir) =&gt;
      fs.statSync(path.join(projectsPath, fileOrDir)).isDirectory()
    ),
};
</code></pre>
<p>This script exports an object with a key of <code>projectNames</code>, which is a node <code>fs</code> (filesystem) process that crawls the <code>projectsPath</code> directory &amp; filters out everything that is not a directory - leaving us with an array of strings that are the names of the folders in the <code>projects</code> directory.</p>
<h3>i18n-extract.js</h3>
<p>Within a new <code>i18n-extract.js</code> file, we can use our new <code>utilities</code> file to prompt the user for the project they want to work with:</p>
<pre><code class="language-js">const prompts = require('prompts');

const { projectNames } = require('./utilities');

const projectPrompt = prompts([
  {
    type: 'autocomplete',
    name: 'project',
    message: 'Choose project:',
    choices: projectNames.map((choice) =&gt; ({ title: choice, value: choice })),
  },
]);

(async () =&gt; {
    const { project } = await projectPrompt;
    console.log(`Selected project: ${project}`);
})();
</code></pre>
<p>At this point, the selected project name is available in the <code>project</code> constant. Here's what we've got:</p>
<p><img src="https://user-images.githubusercontent.com/368723/119405924-a3e22800-bca7-11eb-967f-bfef5da85b19.gif" alt="demo-1"></p>
<p>Now, let's replace the hand typed <code>formatjs extract</code> bash command:</p>
<pre><code class="language-js">(async () =&gt; {
    const { project } = await projectPrompt;

    try {
        await execa( // 1
            'formatjs', // 2
            [
                'extract', // 3
                `'projects/${project}/**/*.ts*' --out-file projects/${project}/translations/en-US.json --id-interpolation-pattern '[sha512:contenthash:base64:6]'`, // 4
            ],
            { shell: true } // 5 
        ).stdout.pipe(process.stdout); // 6
    } catch (error) {
        console.error('error: ', error);
    }
})();
</code></pre>
<p>The actual script itself isn't super relevant for this post, but here are some notes:</p>
<ol>
<li><code>execa</code> is used to make executing in a child process nice &amp; easy</li>
<li><code>formatjs</code> is the binary to execute. <code>execa</code> finds the file automatically (it lives in <code>./node_modules/.bin</code>)</li>
<li>The values in the array are arguments to pass to the command in #2</li>
<li>Interpolates the <code>project</code> variable, using the value the user chose in the prompt</li>
<li>We need to pass <code>shell: true</code> as an option, otherwise the node script won't spawn the correct process</li>
<li><code>stdout</code> is piped through, so we can see any status codes or messages</li>
</ol>
<hr>
<p>That's pretty much it! Hope it helps. Here's the final <code>i18n-extract.js</code> file, altogether:</p>
<pre><code class="language-js">const prompts = require('prompts');

const { projectNames } = require('./utilities');

const projectPrompt = prompts([
  {
    type: 'autocomplete',
    name: 'project',
    message: 'Choose project:',
    choices: projectNames.map((choice) =&gt; ({ title: choice, value: choice })),
  },
]);

(async () =&gt; {
    const { project } = await projectPrompt;

    try {
        await execa(
            'formatjs',
            [
                'extract',
                `'projects/${project}/**/*.ts*' --out-file projects/${project}/translations/en-US.json --id-interpolation-pattern '[sha512:contenthash:base64:6]'`,
            ],
            { shell: true } 
        ).stdout.pipe(process.stdout);
    } catch (error) {
        console.error('error: ', error);
    }
})();
</code></pre>

    <a href="/">← Back</a>
  </body>
</html>
